generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                     String               @id @default(cuid())
  email                  String               @unique
  emailVerified          DateTime?
  password               String?
  name                   String
  role                   Role                 @default(EMPLOYEE)
  jobTitle               String?
  status                 Status               @default(PENDING)
  dailyTarget            Float?
  workDays               Int[]
  workMode               WorkMode             @default(TIME_BASED)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  image                  String?
  resetToken             String?
  resetTokenExpiry       DateTime?
  groupId                String?
  managerId              String?
  projectId              String?
  pendingProjectId       String?
  secondaryManagerId     String?
  sharedChiefGroupId     String?
  lastSeen               DateTime?
  plan                   Plan                 @default(FREE)
  stripeCurrentPeriodEnd DateTime?
  stripeCustomerId       String?              @unique
  stripePriceId          String?
  stripeSubscriptionId   String?              @unique
  removedAt              DateTime?
  weeklyHours            Json?
  accounts               Account[]
  analyticsSnapshots     AnalyticsSnapshot[]
  calendarSettings       CalendarSettings?
  createdEvents          Event[]              @relation("CreatedEvents")
  eventParticipants      EventParticipant[]
  managedGroups          Group[]              @relation("GroupManager")
  notifications          Notification[]
  projectMemberships     ProjectMember[]
  recommendations        Recommendation[]
  secondaryManagers      SecondaryManager[]   @relation("SecondaryManagers")
  secondaryManagedUsers  SecondaryManager[]   @relation("SecondaryManagedUsers")
  sessions               Session[]
  activities             TaskActivity[]
  taskAttachments        TaskAttachment[]
  taskNotes              TaskNote[]
  timeEntries            TimeEntry[]
  group                  Group?               @relation("GroupMembers", fields: [groupId], references: [id])
  manager                User?                @relation("UserHierarchy", fields: [managerId], references: [id])
  directReports          User[]               @relation("UserHierarchy")
  project                Project?             @relation(fields: [projectId], references: [id])
  insightSettings        UserInsightSettings?
  workdays               Workday[]
  tasks                  Task[]               @relation("TaskToUser")
  watchedTasks           Task[]               @relation("TaskWatchers")
}

model SecondaryManager {
  id          String   @id @default(cuid())
  employeeId  String
  managerId   String
  permissions String[]
  createdAt   DateTime @default(now())
  employee    User     @relation("SecondaryManagers", fields: [employeeId], references: [id], onDelete: Cascade)
  manager     User     @relation("SecondaryManagedUsers", fields: [managerId], references: [id], onDelete: Cascade)

  @@unique([employeeId, managerId])
  @@index([employeeId])
  @@index([managerId])
}

model Project {
  id                    String          @id @default(cuid())
  name                  String
  joinCode              String          @unique @default(cuid())
  logo                  String?
  workMode              WorkMode        @default(TIME_BASED)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  workLocationAddress   String?
  workLocationLatitude  Float?
  workLocationLongitude Float?
  workLocationRadius    Float?          @default(150)
  isRemoteWork          Boolean         @default(true)
  events                Event[]
  groups                Group[]
  members               ProjectMember[]
  tasks                 Task[]
  taskLabels            TaskLabel[]
  timeEntries           TimeEntry[]
  users                 User[]
  workdays              Workday[]
}

model ProjectMember {
  id        String       @id @default(cuid())
  userId    String
  projectId String
  role      Role         @default(EMPLOYEE)
  joinedAt  DateTime     @default(now())
  status    MemberStatus @default(ACTIVE)
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  color       String   @default("#3B82F6")
  projectId   String
  managerId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  manager     User?    @relation("GroupManager", fields: [managerId], references: [id])
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  members     User[]   @relation("GroupMembers")
}

model Workday {
  id                    String    @id @default(cuid())
  userId                String
  workdayStartTime      DateTime
  workdayEndTime        DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  locationRequired      Boolean   @default(false)
  startLocationLat      Float?
  startLocationLng      Float?
  startLocationVerified Boolean   @default(false)
  endLocationLat        Float?
  endLocationLng        Float?
  endLocationVerified   Boolean   @default(false)
  locationStatus        String?
  projectId             String?
  project               Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, workdayStartTime])
  @@index([userId])
  @@index([projectId])
}

model TimeEntry {
  id          String       @id @default(cuid())
  userId      String
  startTime   DateTime
  endTime     DateTime?
  description String?
  isManual    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  subtaskId   String?
  projectId   String?
  breaks      TimeBreak[]
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  subtask     SubTaskItem? @relation(fields: [subtaskId], references: [id])
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks       Task[]       @relation("TaskToTimeEntry")

  @@index([projectId])
}

model TimeBreak {
  id          String    @id @default(cuid())
  timeEntryId String
  startTime   DateTime
  endTime     DateTime?
  locationLat Float?
  locationLng Float?
  reason      String?
  timeEntry   TimeEntry @relation(fields: [timeEntryId], references: [id], onDelete: Cascade)
}

model Task {
  id          String           @id @default(cuid())
  title       String
  description String?
  status      TaskStatus       @default(TODO)
  priority    TaskPriority     @default(MEDIUM)
  deadline    DateTime?
  isCompleted Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  startDate   DateTime?
  projectId   String?
  checklist   ChecklistItem[]
  subtasks    SubTaskItem[]
  project     Project?         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  activities  TaskActivity[]
  attachments TaskAttachment[]
  notes       TaskNote[]
  Task_A      Task[]           @relation("TaskDependencies")
  Task_B      Task[]           @relation("TaskDependencies")
  labels      TaskLabel[]      @relation("TaskToTaskLabel")
  timeEntries TimeEntry[]      @relation("TaskToTimeEntry")
  assignees   User[]           @relation("TaskToUser")
  watchers    User[]           @relation("TaskWatchers")

  @@index([projectId])
}

model ChecklistItem {
  id        String   @id @default(cuid())
  taskId    String
  text      String
  isDone    Boolean  @default(false)
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

model TaskNote {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TaskAttachment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  fileName  String
  fileType  String
  fileKey   String
  fileUrl   String
  fileSize  Int
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TaskLabel {
  id        String  @id @default(cuid())
  name      String
  color     String
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks     Task[]  @relation("TaskToTaskLabel")

  @@unique([projectId, name])
  @@index([projectId])
}

model SubTaskItem {
  id          String      @id @default(cuid())
  taskId      String
  title       String
  isDone      Boolean     @default(false)
  createdAt   DateTime    @default(now())
  task        Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)
  timeEntries TimeEntry[]
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  link      String?
  type      NotificationType @default(INFO)
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Event {
  id            String             @id @default(cuid())
  title         String
  description   String?
  startTime     DateTime
  endTime       DateTime
  allDay        Boolean            @default(false)
  location      String?
  type          EventType          @default(MEETING)
  recurrence    RecurrenceType?
  recurrenceEnd DateTime?
  createdById   String
  projectId     String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  createdBy     User               @relation("CreatedEvents", fields: [createdById], references: [id], onDelete: Cascade)
  project       Project?           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  participants  EventParticipant[]
  reminders     EventReminder[]

  @@index([createdById])
  @@index([projectId])
  @@index([startTime])
}

model EventParticipant {
  id      String            @id @default(cuid())
  eventId String
  userId  String
  status  ParticipantStatus @default(PENDING)
  event   Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
}

model EventReminder {
  id            String  @id @default(cuid())
  eventId       String
  minutesBefore Int
  sent          Boolean @default(false)
  event         Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model TaskActivity {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  action    String
  details   String?
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  refresh_token_expires_in Int?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model AnalyticsSnapshot {
  id              String   @id @default(cuid())
  userId          String
  date            DateTime @default(now())
  totalHours      Float
  productiveHours Float
  tasksCompleted  Int
  breaksTaken     Int
  focusScore      Float
  efficiencyScore Float
  balanceScore    Float
  peakHourStart   Int?
  peakHourEnd     Int?
  longestSession  Int
  averageSession  Int
  burnoutRisk     Boolean  @default(false)
  overtimeHours   Float    @default(0)
  lateWorkHours   Float    @default(0)
  weekendWork     Float    @default(0)
  consecutiveDays Int      @default(0)
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model UserInsightSettings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  dailyHoursWarning   Float    @default(10)
  weeklyHoursWarning  Float    @default(50)
  minBreaksPerDay     Int      @default(2)
  maxConsecutiveDays  Int      @default(7)
  enableWeeklyReport  Boolean  @default(true)
  enableBurnoutAlerts Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Recommendation {
  id        String                 @id @default(cuid())
  userId    String
  type      RecommendationType
  priority  RecommendationPriority
  title     String
  message   String
  actionUrl String?
  dismissed Boolean                @default(false)
  createdAt DateTime               @default(now())
  user      User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dismissed])
}

model CalendarSettings {
  id                          String    @id @default(cuid())
  userId                      String    @unique
  isGoogleCalendarSyncEnabled Boolean   @default(false)
  syncedCalendarIds           String[]  @default(["primary"])
  syncMode                    SyncMode  @default(FULL_DETAILS)
  lastSyncedAt                DateTime?
  syncToken                   String?
  googleEventsCache           Json?
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt
  user                        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum MemberStatus {
  ACTIVE
  PENDING
  INVITED
  REJECTED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
  MEMBER
}

enum Status {
  PENDING
  ACTIVE
  REJECTED
}

enum NotificationType {
  INFO
  WARNING
  SUCCESS
  ERROR
}

enum WorkMode {
  OUTPUT_BASED
  TIME_BASED
  PROJECT_BASED
}

enum EventType {
  MEETING
  APPOINTMENT
  TASK_TIME
  BREAK
  PERSONAL
  OTHER
}

enum RecurrenceType {
  DAILY
  WEEKLY
  MONTHLY
}

enum ParticipantStatus {
  PENDING
  ACCEPTED
  DECLINED
  TENTATIVE
}

enum RecommendationType {
  SCHEDULE_OPTIMIZATION
  BREAK_REMINDER
  WORKLOAD_BALANCE
  SKILL_DEVELOPMENT
  BURNOUT_PREVENTION
  EFFICIENCY_TIP
}

enum RecommendationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum Plan {
  FREE
  TIER1
  TIER2
  TIER3
}

enum SyncMode {
  FULL_DETAILS
  BUSY_ONLY
}
